owner-repo: &owner-repo
  owner-repo: palantir/amalgomate

version: 2.1

orbs:
  go: palantir/go@0.0.12
  godel: palantir/godel@0.0.12

jobs:
  wiki:
    executor:
      name: go/golang
      version: 1.13.3
      <<: *owner-repo
    steps:
      - add_ssh_keys:
          fingerprints:
            - "09:b4:ca:57:7c:78:f9:0e:27:e4:96:84:a1:8c:8d:6e"
      - godel/setup
      - run: ./godelw github-wiki --docs-dir docs --repository=git@github.com:palantir/amalgomate.wiki.git

workflows:
  version: 2
  verify-test:
    jobs:
      - godel/verify:
          name: verify
          executor:
            name: go/golang
            version: 1.13.3
            <<: *owner-repo
      - godel/test:
          name: test
          executor:
            name: go/golang
            version: 1.13.3
            <<: *owner-repo
      - wiki:
          requires:
            - verify
          filters:
            branches:
              only: /^master$/
